#!/usr/bin/env bash

set -uo pipefail

tag_components=(
    "cmd/configschema/"
    "cmd/mdatagen/"
    "cmd/telemetrygen"
    "confmap/provider/s3provider/"
    "connector/countconnector/"
    "connector/servicegraphconnector/"
    "connector/spanmetricsconnector/"
    "examples/demo/client/"
    "examples/demo/server/"
    "exporter/alibabacloudlogserviceexporter/"
    "exporter/awscloudwatchlogsexporter/"
    "exporter/awsemfexporter/"
    "exporter/awskinesisexporter/"
    "exporter/awsxrayexporter/"
    "exporter/azuredataexplorerexporter/"
    "exporter/azuremonitorexporter/"
    "exporter/carbonexporter/"
    "exporter/clickhouseexporter/"
    "exporter/coralogixexporter/"
    "exporter/datadogexporter/"
    "exporter/dynatraceexporter/"
    "exporter/elasticsearchexporter/"
    "exporter/f5cloudexporter/"
    "exporter/fileexporter/"
    "exporter/googlecloudexporter/"
    "exporter/googlemanagedprometheusexporter/"
    "exporter/googlecloudpubsubexporter/"
    "exporter/influxdbexporter/"
    "exporter/instanaexporter/"
    "exporter/jaegerexporter/"
    "exporter/jaegerthrifthttpexporter/"
    "exporter/kafkaexporter/"
    "exporter/loadbalancingexporter/"
    "exporter/logicmonitorexporter/"
    "exporter/logzioexporter/"
    "exporter/lokiexporter/"
    "exporter/mezmoexporter/"
    "exporter/opencensusexporter/"
    "exporter/parquetexporter/"
    "exporter/prometheusexporter/"
    "exporter/prometheusremotewriteexporter/"
    "exporter/pulsarexporter/"
    "exporter/sapmexporter/"
    "exporter/sentryexporter/"
    "exporter/signalfxexporter/"
    "exporter/skywalkingexporter/"
    "exporter/splunkhecexporter/"
    "exporter/sumologicexporter/"
    "exporter/tanzuobservabilityexporter/"
    "exporter/tencentcloudlogserviceexporter/"
    "exporter/zipkinexporter/"
    "extension/asapauthextension/"
    "extension/awsproxy/"
    "extension/basicauthextension/"
    "extension/bearertokenauthextension/"
    "extension/headerssetterextension/"
    "extension/healthcheckextension/"
    "extension/httpforwarder/"
    "extension/jaegerremotesampling/"
    "extension/oauth2clientauthextension/"
    "extension/observer/"
    "extension/observer/dockerobserver/"
    "extension/observer/ecsobserver/"
    "extension/observer/ecstaskobserver/"
    "extension/observer/hostobserver/"
    "extension/observer/k8sobserver/"
    "extension/oidcauthextension/"
    "extension/pprofextension/"
    "extension/sigv4authextension/"
    "extension/storage/"
    "internal/aws/awsutil/"
    "internal/aws/cwlogs/"
    "internal/aws/containerinsight/"
    "internal/aws/ecsutil/"
    "internal/aws/k8s/"
    "internal/aws/metrics/"
    "internal/aws/proxy/"
    "internal/aws/xray/"
    "internal/aws/xray/testdata/sampleapp/"
    "internal/aws/xray/testdata/sampleserver/"
    "internal/common/"
    "internal/coreinternal/"
    "internal/docker/"
    "internal/filter/"
    "internal/influx/"
    "internal/k8sconfig/"
    "internal/kubelet/"
    "internal/metadataproviders/"
    "internal/sharedcomponent/"
    "internal/splunk/"
    "pkg/batchperresourceattr/"
    "pkg/batchpersignal/"
    "pkg/experimentalmetricmetadata/"
    "pkg/pdatatest/"
    "pkg/pdatautil/"
    "pkg/resourcetotelemetry/"
    "pkg/stanza/"
    "pkg/ottl/"
    "pkg/translator/jaeger/"
    "pkg/translator/loki/"
    "pkg/translator/opencensus/"
    "pkg/translator/prometheus/"
    "pkg/translator/prometheusremotewrite/"
    "pkg/translator/signalfx/"
    "pkg/winperfcounters/"
    "pkg/translator/zipkin/"
    "processor/attributesprocessor/"
    "processor/cumulativetodeltaprocessor/"
    "processor/datadogprocessor/"
    "processor/deltatorateprocessor/"
    "processor/filterprocessor/"
    "processor/groupbyattrsprocessor/"
    "processor/groupbytraceprocessor/"
    "processor/k8sattributesprocessor/"
    "processor/logstransformprocessor/"
    "processor/metricsgenerationprocessor/"
    "processor/metricstransformprocessor/"
    "processor/probabilisticsamplerprocessor/"
    "processor/redactionprocessor/"
    "processor/resourcedetectionprocessor/"
    "processor/resourceprocessor/"
    "processor/routingprocessor/"
    "processor/schemaprocessor/"
    "processor/servicegraphprocessor/"
    "processor/spanmetricsprocessor/"
    "processor/spanprocessor/"
    "processor/tailsamplingprocessor/"
    "processor/transformprocessor/"
    "receiver/activedirectorydsreceiver/"
    "receiver/aerospikereceiver/"
    "receiver/apachereceiver/"
    "receiver/awscloudwatchreceiver/"
    "receiver/awscontainerinsightreceiver/"
    "receiver/awsecscontainermetricsreceiver/"
    "receiver/awsfirehosereceiver/"
    "receiver/awsxrayreceiver/"
    "receiver/azureeventhubreceiver/"
    "receiver/azureblobreceiver/"
    "receiver/bigipreceiver/"
    "receiver/carbonreceiver/"
    "receiver/cloudfoundryreceiver/"
    "receiver/chronyreceiver/"
    "receiver/collectdreceiver/"
    "receiver/couchdbreceiver/"
    "receiver/datadogreceiver/"
    "receiver/dockerstatsreceiver/"
    "receiver/dotnetdiagnosticsreceiver/"
    "receiver/elasticsearchreceiver/"
    "receiver/expvarreceiver/"
    "receiver/filelogreceiver/"
    "receiver/filereceiver/"
    "receiver/flinkmetricsreceiver/"
    "receiver/fluentforwardreceiver/"
    "receiver/googlecloudpubsubreceiver/"
    "receiver/googlecloudspannerreceiver/"
    "receiver/haproxyreceiver/"
    "receiver/hostmetricsreceiver/"
    "receiver/httpcheckreceiver/"
    "receiver/influxdbreceiver/"
    "receiver/iisreceiver/"
    "receiver/jaegerreceiver/"
    "receiver/jmxreceiver/"
    "receiver/journaldreceiver/"
    "receiver/k8sclusterreceiver/"
    "receiver/k8seventsreceiver/"
    "receiver/k8sobjectsreceiver/"
    "receiver/kafkametricsreceiver/"
    "receiver/kafkareceiver/"
    "receiver/kubeletstatsreceiver/"
    "receiver/memcachedreceiver/"
    "receiver/mongodbreceiver/"
    "receiver/mongodbatlasreceiver/"
    "receiver/mysqlreceiver/"
    "receiver/nginxreceiver/"
    "receiver/nsxtreceiver/"
    "receiver/opencensusreceiver/"
    "receiver/oracledbreceiver/"
    "receiver/otlpjsonfilereceiver/"
    "receiver/podmanreceiver/"
    "receiver/postgresqlreceiver/"
    "receiver/prometheusexecreceiver/"
    "receiver/prometheusreceiver/"
    "receiver/purefareceiver/"
    "receiver/purefbreceiver/"
    "receiver/rabbitmqreceiver/"
    "receiver/receivercreator/"
    "receiver/redisreceiver/"
    "receiver/riakreceiver/"
    "receiver/sapmreceiver/"
    "receiver/saphanareceiver/"
    "receiver/signalfxreceiver/"
    "receiver/simpleprometheusreceiver/"
    "receiver/simpleprometheusreceiver/examples/federation/prom-counter/"
    "receiver/skywalkingreceiver/"
    "receiver/snmpreceiver/"
    "receiver/snowflakereceiver/"
    "receiver/solacereceiver/"
    "receiver/splunkhecreceiver/"
    "receiver/sqlqueryreceiver/"
    "receiver/sqlserverreceiver/"
    "receiver/sshcheckreceiver/"
    "receiver/statsdreceiver/"
    "receiver/syslogreceiver/"
    "receiver/tcplogreceiver/"
    "receiver/udplogreceiver/"
    "receiver/vcenterreceiver/"
    "receiver/wavefrontreceiver/"
    "receiver/windowseventlogreceiver/"
    "receiver/windowsperfcountersreceiver/"
    "receiver/zipkinreceiver/"
    "receiver/zookeeperreceiver/"
    "receiver/pulsarreceiver/"
    "testbed/"
    "testbed/mockdatareceivers/mockawsxrayreceiver/"
    "testbed/mockdatasenders/mockdatadogagentexporter/"
    ""
)

upstream_version=$(curl -sL https://api.github.com/repos/open-telemetry/opentelemetry-collector/releases/latest | jq -r ".tag_name" -e | sed 's/cmd\/builder\///g')
otel_version="${2:-${upstream_version}}"
patch_number="${3:-1}"
tag_version="${otel_version}-fn.patch.${patch_number}"

tag_names=()
for component in "${tag_components[@]}"; do
    tag_name="${component}${tag_version}"
    tag_names+=($tag_name)
done

make_tags() {
    for tag_name in "${tag_names[@]}"; do
        echo "Tagging as ${tag_name}"
        git tag ${tag_name}
    done
    return
}

push_tags() {
    echo "Pushing tags ${tag_names[@]}"
    git push origin ${tag_names[@]}
    return
}

case "${1}" in
    make) make_tags;;
    push) push_tags;;
    *) printf 'Unknown command - "%s"\n' "${1}"; exit 1;;
esac
